"use strict";angular.module("geosApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase","firebase.ref","firebase.auth","uiGmapgoogle-maps","angularGeoFire"]),angular.module("firebase.config",[]).constant("FBURL","https://skeleton-firebase.firebaseio.com").constant("SIMPLE_LOGIN_PROVIDERS",["anonymous"]).constant("loginRedirectPath","/login"),angular.module("firebase.ref",["firebase","firebase.config"]).factory("Ref",["$window","FBURL",function(a,b){return new a.Firebase(b)}]),angular.module("geosApp").filter("reverse",function(){return function(a){return angular.isArray(a)?a.slice().reverse():[]}}),function(){angular.module("firebase.auth",["firebase","firebase.ref"]).factory("Auth",["$firebaseAuth","Ref",function(a,b){return a(b)}])}(),angular.module("geosApp").controller("MainCtrl",["$scope","$routeParams","Ref","uiGmapGoogleMapApi",function(a,b,c,d){console.log("mainctrl");var e=null,f=null,g=["sa0"],h=function(){if(f){var a=f.getCenter(),b=f.getBounds(),a=b.getCenter(),c=b.getNorthEast(),d=3963,g=a.lat()/57.2958,h=a.lng()/57.2958,i=c.lat()/57.2958,j=c.lng()/57.2958,k=d*Math.acos(Math.sin(g)*Math.sin(i)+Math.cos(g)*Math.cos(i)*Math.cos(j-h));console.log(k),e&&e.updateCriteria({center:[a.lat(),a.lng()],radius:k})}};a.map={center:{latitude:45,longitude:-73},zoom:8,events:{tilesloaded:function(c){if(!a.map._ready&&(a.map._ready=!0,f=c,b.location)){var d=new google.maps.Geocoder;d.geocode({address:b.location},function(a,b){if(b===google.maps.GeocoderStatus.OK){f.setCenter(a[0].geometry.location),f.fitBounds(a[0].geometry.viewport),h();var c=f.getBounds().getNorthEast(),d=3963,e=f.center.lat()/57.2958,g=f.center.lng()/57.2958,j=c.lat()/57.2958,k=c.lng()/57.2958,l=d*Math.acos(Math.sin(e)*Math.sin(j)+Math.cos(e)*Math.cos(j)*Math.cos(k-g));i([f.center.lat(),f.center.lng()],l)}else alert("Geocode was not successful."+b)})}},zoom_changed:h,dragend:h}},a.doSearch=function(){window.location.hash="#/search/"+a.search},a.clickMarker=function(a){window.location.hash="#/card/"+a.key;var b=f,c=Math.pow(2,b.getZoom()),d=new google.maps.LatLng(b.getBounds().getNorthEast().lat(),b.getBounds().getSouthWest().lng()),e=b.getProjection().fromLatLngToPoint(d),g=b.getProjection().fromLatLngToPoint(a.location),h=new google.maps.Point(Math.floor((g.x-e.x)*c),Math.floor((g.y-e.y)*c));$("#map-popup").show(),$("#map-popup").css("position","absolute");var i=Number(h.y),j=Number(h.x+20);0>j&&(j=0),0>i&&(i=0),$("#map-popup").css("top",i+"px"),$("#map-popup").css("left",j+"px")},a.highlightMarker=function(a){a.options={animation:1}},a.unhighlightMarker=function(a){a.options={animation:0}},a.searchResults=[];var i=function(b,d){var f=new GeoFire(new Firebase("https://skeleton-firebase.firebaseio.com/thecareworld/geos"));e=f.query({center:b,radius:d}),e.on("key_entered",function(b,d,e){var f=c.child("thecareworld/cards/"+b);f.once("value",function(c){var e=c.val();if(e){var f={latitude:d[0],longitude:d[1]};e.location=f,e.key=b,a.$apply(function(){a.searchResults.push(e)})}})}),e.on("key_exited",function(b,c,d){for(var e=0;e<a.searchResults.length;e++)a.searchResults[e].key==b&&a.searchResults.splice(e,1)})},j=c.child("thecareworld/config/tags");j.once("value",function(b){a.tags=b.val(),l()}),a.activeFilters=[],Array.prototype.chunk=function(a){var b=this;return[].concat.apply([],b.map(function(c,d){return d%a?[]:[b.slice(d,d+a)]}))},a.formatFilterName=function(b){return b.replace(a.activeFilters[0],"")};var k=function(b){if(!b.tags)return!0;for(var c=0;c<a.activeFilters.length;c++){var d=a.activeFilters[c],e=b.tags.split(",");if(-1!=e.indexOf(d))return!0}return!1};a.filter=function(a){return k(a)},a.setFilter=function(b,c){var d=b;2>d&&(d=2),b&&g.length>b&&(g=g.slice(0,d)),g[b]=c,a.activeFilters=g,l(),console.log("filters ",g)};var l=function(){for(var b=[],c=0;c<=g.length;c++){b[c]=[];for(var d=0;d<a.tags.length;d++){var e=a.tags[d].split("/");e.length>c&&e.slice(0,c).join("/")==g.slice(0,c).join("/")&&-1==b[c].indexOf(e[c])&&b[c].push(e[c])}}a.filters=b};a.moreFilters=function(){a.showFilter?a.showFilter=!1:a.showFilter=!0},a.applyFilters=function(){a.showFilter=!1}}]),angular.module("geosApp").controller("LoginCtrl",["$scope","Auth","$location",function(a,b,c){function d(){c.path("/account")}function e(b){a.err=b}a.oauthLogin=function(c){a.err=null,b.$authWithOAuthPopup(c,{rememberMe:!0}).then(d,e)},a.anonymousLogin=function(){a.err=null,b.$authAnonymously({rememberMe:!0}).then(d,e)}}]),angular.module("geosApp").controller("CardCtrl",["$scope","$routeParams","Ref",function(a,b,c){var d=c.child("thecareworld/cards/"+b.cardId);d.once("value",function(b){var c=b.val();c&&(a.card=c,a.$digest())})}]),angular.module("geosApp").directive("ngShowAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("geosApp").directive("ngHideAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("geosApp").config(["$routeProvider","SECURED_ROUTES",function(a,b){a.whenAuthenticated=function(c,d){return d.resolve=d.resolve||{},d.resolve.user=["Auth",function(a){return a.$requireAuth()}],a.when(c,d),b[c]=!0,a}}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/search/:location",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/card/:cardId",{templateUrl:"views/card.html",controller:"CardCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","Auth","SECURED_ROUTES","loginRedirectPath",function(a,b,c,d,e){function f(a){!a&&g(b.path())&&b.path(e)}function g(a){return d.hasOwnProperty(a)}c.$onAuth(f),a.$on("$routeChangeError",function(a,c,d,f){"AUTH_REQUIRED"===f&&b.path(e)})}]).constant("SECURED_ROUTES",{});